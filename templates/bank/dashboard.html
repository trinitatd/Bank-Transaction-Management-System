{% extends 'bank/base.html' %}
{% block title %}Dashboard - BTMS{% endblock %}
{% block content %}
<div class="card">
    <h2>Welcome, {{ customer.name }}</h2>
    <p class="muted">Aadhaar: {{ customer.aadhaar_no }} | Phone: {{ customer_phone|default:customer.phone }}</p>

    <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1" class="card">
            <h4>Total Balance</h4>
            <div style="font-size:22px">₹{{ total_balance }}</div>
            <div class="muted">Accounts: {{ accounts|length }}</div>

            <div style="margin-top:8px">
                <strong>Accounts</strong>
                <ul>
                    {% for a in accounts %}
                        <li>
                            {{ a.account_no }} — ₹{{ a.balance }}
                            <a class="btn btn-sm btn-outline-danger" href="{% url 'close_account' a.account_no %}" style="margin-left:8px">Close</a>
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'reconcile_account' a.account_no %}" style="margin-left:6px">Reconcile</a>
                        </li>
                    {% empty %}
                        <li>No accounts</li>
                    {% endfor %}
                </ul>

                <div style="margin-top:8px">
                    <a class="btn" href="{% url 'my_transactions' %}">Transactions</a>
                </div>
            </div>
        </div>

        <div style="flex:2" class="card">
            <h4>Recent Transactions</h4>
            <table>
                <tr><th>Date</th><th>Account</th><th>Type</th><th>Amount</th></tr>
                {% for tx in recent_transactions %}
                    <tr>
                        <td class="muted">{{ tx.date }}</td>
                        <td>
                            {% if tx.account %}
                                {{ tx.account.account_no }}
                            {% elif tx.account_no %}
                                {{ tx.account_no }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{% if tx.transaction_type %}{{ tx.transaction_type }}{% else %}{{ tx.type }}{% endif %}</td>
                        <td>₹{{ tx.amount }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4">No recent transactions</td></tr>
                {% endfor %}
            </table>
        </div>
    </div>
</div>

<!-- ✅ Fixed Loans section -->
<div class="card" style="margin-top:20px">
    <h3>Loans</h3>
    <ul>
        {% for cl in customer_loans %}
            <li>
                {{ cl.loan.type }} — ₹{{ cl.loan.amount }} ({{ cl.role }})
                {% if cl.loan.loan_no %}
                    <a class="btn btn-sm btn-primary" href="{% url 'pay_loan' cl.loan.loan_no %}" style="margin-left:8px">Pay</a>
                {% else %}
                    <span class="text-muted" style="margin-left:8px">No Loan No</span>
                {% endif %}
            </li>
        {% empty %}
            <li>No loans</li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

